# V5.1 设计哲学：带符号 DDM 与规范强化

## 修订动因

V5 的个体规范涌现机制在审计中暴露了四个相互关联的问题，它们共享同一个根源——DDM 证据积累器是无符号的。

### 问题诊断

| # | 问题 | 严重性 | 根源 |
|---|------|--------|------|
| 1 | 50-50 噪声产生正 drift，~8 ticks 即虚假结晶 | 高 | `consistency = max(f_A, f_B)` 在 50-50 时 = 0.5 > 0 |
| 2 | A 一致性和 B 一致性都喂同一个积累器，可能结晶为错误方向 | 中 | 积累器不区分策略，规范身份仅在结晶瞬间由快照决定 |
| 3 | σ 结晶后只降不升，compliance 天花板 0.64 | 低 | 缺少正向强化机制 |
| 4 | 执法信号不可累积且无方向性 | 低 | `signal_boost` 是乘数，覆盖而非累加 |

问题 1 和 2 是**致命的**：它们意味着规范可以从纯随机噪声中诞生，且可能指向错误方向。这与 Germar et al. (2014) 的实验前提矛盾——该实验使用的是明确的社会多数作为影响源。

## 设计原则

### 原则 1：证据方向性

> 支持 A 的证据和支持 B 的证据应当**相互抵消**，而非叠加。

这是最基本的修正。如果一个 agent 在 tick 10 观察到 A 占优、tick 11 观察到 B 占优，它对"存在规范"的信念不应增加——环境是混乱的，不是有规范的。

**数学表达**：将无符号一致性 `max(f_A, f_B)` 替换为带符号差 `f_A - f_B`。

### 原则 2：沉默即无信号

> 当群体处于 50-50 时，DDM 不应接收到任何系统性信号。

当前模型在 50-50 时 drift = (1-C) × 0.5 > 0，相当于告诉 agent "存在一个规范，只是你不知道是哪个"。这在认知上不合理——真正的无序应产生零信号。

**数学表达**：50-50 → `f_A - f_B = 0` → drift = 0。证据做纯随机游走，期望结晶时间 θ²/σ² ≈ 900 ticks。

### 原则 3：与 Germar (2014) 的标准 DDM 对齐

> 使用双吸收边界 DDM，而非单边界反射模型。

Germar et al. 的原始实验使用标准双边界 DDM：被试可以偏向 A 或偏向 B。我们的模型应保持同构：

- **+θ 边界**：证据充分支持 A → 结晶 A-规范
- **-θ 边界**：证据充分支持 B → 结晶 B-规范
- **中间区域**：证据不足，尚未结晶

这自然消除了反射边界（`max(0, ...)`），因为证据需要能向两个方向累积。

### 原则 4：规范在使用中强化

> 反复被验证的规范应逐渐变强，而非停滞在初始值。

这来自多条证据线：

- Will et al. (2023)：更强的内化 → 更强的遵从
- Gintis (2003)：内化规范创造内在动机，遵从随实践加深
- Andrighetto et al. (2015)：遵从成为"目的本身"
- 习惯形成文献（Wood & Rünger 2016）：反复执行的行为自动化

实现方式与置信度更新同构：加法上升、饱和于 1，速率远小于危机衰减。这保持了 V5 的核心不对称性（"易碎难修"），同时让规范有成长空间。

### 原则 5：执法信号携带方向

> 执法信号应明确指向被执法的策略，而非仅放大当前 drift。

在带符号 DDM 中，drift 的方向由当前观察决定。如果 agent 恰好在该 tick 观察到反方向占优（采样噪声），旧的乘法信号会把证据推向**错误方向**。改为加法定向推力确保信号始终推向被执法的策略。

### 原则 6：最小侵入

> 修改应集中在 DDM 内部，不改变 V5 的整体架构。

以下不变：
- 置信度更新公式
- 记忆窗口耦合
- 遵从函数 σ^k
- 有效信念混合
- 异常积累
- 危机/解体
- 执法触发条件
- tick 流水线执行顺序
- 规范检测层级

## 修改规格

### 修改 1：带符号双边界 DDM

**替换 Eq. 5–7**

旧：
```
drift   = (1 - C) × max(f_A, f_B) × signal_boost
e(t+1)  = max(0, e(t) + drift + N(0, σ²))
e > θ   → r = dominant_strategy
```

新：
```
drift   = (1 - C) × (f_A - f_B)
e(t+1)  = e(t) + drift + signal_push + N(0, σ²)
|e| ≥ θ → r = A if e > 0, B if e < 0
```

**参数变化**：无新参数。θ_crystal、σ_noise 含义不变。

**代码影响**：
- `NormativeMemory.update_evidence()`：去掉 `max(0, ...)`；接受带符号 consistency
- `Agent.process_normative_observations()`：计算 `f_A - f_B` 替代 `max(counts) / total`
- 结晶时：`r_i = 0 if e > 0 else 1`（策略 0 = A，1 = B 的约定不变）

### 修改 2：σ 强化

**在 Eq. 10 后新增**

```
如果 observed_strategy == r_i:
    σ ← min(1, σ + α_σ(1 - σ))
```

**新参数**：α_σ = 0.005（每次符合观察）

**代码影响**：
- `NormativeMemory` 新增 `record_conformity()` 方法
- `Agent.process_normative_observations()` 在 post-crystallisation 路径中调用

### 修改 3：定向执法信号

**替换 Eq. 17**

旧：
```
drift_signal = (1 - C) × consistency × γ_signal
```

新：
```
signal_push = (1 - C) × γ_signal × dir(s_enforced)
其中 dir(A) = +1, dir(B) = -1
```

signal_push 在下一次 `update_evidence()` 调用时加入 drift。

**代码影响**：
- `NormativeMemory.receive_signal()` 接受 strategy 和 amplification 两个参数
- `NormativeMemory.update_evidence()` 将 signal_push 加入 drift（不再是乘数）
- `Agent.receive_normative_signal()` 传递 strategy 参数

## 不变量

以下性质在修改前后必须保持：

1. **V1 后向兼容**：`enable_normative=False` 时行为完全不变
2. **tick 流水线顺序**：6 步执行顺序不变
3. **所有 63 个现有测试**中不涉及 DDM 内部细节的测试应继续通过
4. **稳态置信度公式** C* = pα/(pα+(1-p)β) 不变
5. **规范检测层级**（6 级）定义不变
6. **遵从函数** σ^k 不变
7. **危机机制** σ *= λ_crisis 不变

## 预期行为变化

| 指标 | 旧 V5 | 新 V5.1 | 变化原因 |
|------|-------|---------|---------|
| 50-50 时结晶时间 | ~8 ticks | ~900 ticks | 零 drift |
| 70-30 时结晶时间 | ~4 ticks | ~13 ticks | drift 从 0.7 降至 0.24 |
| 错误方向结晶率 | 取决于采样 | ~0% | 带符号积累 |
| 最终 compliance（200 ticks 后） | 0.64 | ~0.95 | σ 强化 |
| 危机后恢复可能性 | 不可能 | ~29 ticks 恢复执法 | σ 强化 |

## 验证计划

1. **单元测试**：DDM 在 50-50 输入下不结晶（1000 ticks 内）
2. **单元测试**：DDM 在 80-20 输入下结晶为正确方向
3. **单元测试**：σ 强化在 100 次符合观察后 σ > 0.95
4. **单元测试**：定向信号推动证据向正确方向
5. **集成测试**：V1 模式（无规范记忆）行为不变
6. **回归测试**：所有不涉及 DDM 内部的现有测试通过
7. **冒烟测试**：`python main.py --agents 10 --ticks 50 --normative --no-save --no-plot`
